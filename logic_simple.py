
import streamlit as st
import random
def confidence_letter(score: float):
    """0.0〜1.0をA/B/Cの確からしさに変換"""
    if score >= 0.8: return "A", "高い（かなり当てはまりそう）"
    if score >= 0.6: return "B", "中くらい（それっぽいが他の可能性も）"
    return "C", "低め（参考程度）"

import streamlit as st  # ←先頭に入っていることを確認

def render_finding_card(f: dict):
    # 安全な取り出し（型も整える）
    label = str(f.get("label", "（名称未設定）"))
    score = float(f.get("score", 0.0) or 0.0)
    tips  = list(f.get("suggestions") or [])
    evid  = list(f.get("evidence") or [])
    why   = str(f.get("why", ""))

    st.markdown(f'<div class="card"><b>{label}</b>'
                f'<span class="badge">確からしさ: {score:.2f}</span></div>',
                unsafe_allow_html=True)

    if why:
        st.markdown(f"**なぜ？（短い説明）**　{why}")

    if evid:
        st.caption("ヒントになった言葉: " + "、".join(map(str, evid[:3])))

    if tips:
        st.markdown("**すぐ試せる対処**")
        for t in tips[:4]:
            st.markdown("- " + str(t))


def analyze_selection(theme: str, situation: str, sign: str, text: str):
    """
    かんたんルールベース：
      - A/B/C各ステップの組み合わせと、テキスト内のキーワードから
        代表的なバイアス候補を返す
    """
    text = (text or "").lower()

    # 候補辞書：分かりやすい日本語ラベル＋やさしい説明＋行動ヒント
    BIASES = [
        {
            "key": "loss_aversion",
            "label": "損失回避（損を強く避けたくなる）",
            "why": "人は同じ量の得より、同じ量の損を2倍くらい強く感じがちです。",
            "match": lambda th, si, sg, tx: ("損" in sg) or ("損" in tx) or (th=="買い物" and "セール" in tx),
            "tips": [
                "損ではなく“合計いくら払うか”で見る（%ではなく円・時間に言い換える）",
                "買わない選択も候補に入れて3つの案を比べる",
                "一晩おいてからもう一度判断する（24時間ルール）"
            ],
            "score": lambda th, si, sg, tx: 0.8 if ("損" in sg or "セール" in tx) else 0.65
        },
        {
            "key": "anchoring",
            "label": "アンカリング（最初の数字に引っぱられる）",
            "why": "最初に見た定価や点数が“基準”になって、その後の判断がゆがみます。",
            "match": lambda th, si, sg, tx: ("定価" in tx) or ("元値" in tx) or ("セール" in tx),
            "tips": [
                "比べる数字を2つ以上にする（相場・ベースレートを見る）",
                "“今の自分に必要か”で判断する（数字だけで決めない）"
            ],
            "score": lambda th, si, sg, tx: 0.7 if ("定価" in tx or "元値" in tx) else 0.6
        },
        {
            "key": "framing",
            "label": "フレーミング効果（言い方で印象が変わる）",
            "why": "『90%成功』と『10%失敗』は中身が同じでも感じ方が変わります。",
            "match": lambda th, si, sg, tx: ("成功" in tx and "失敗" in tx) or (th in ["買い物","お金"] and "割引" in tx),
            "tips": [
                "別の言い方に言い換えてから判断（%⇔円、得⇔損）",
                "第三者の短評を3行で書く（外部視点）"
            ],
            "score": lambda th, si, sg, tx: 0.6
        },
        {
            "key": "status_quo",
            "label": "現状維持バイアス（変えない方を選びやすい）",
            "why": "人は慣れた状態を好みます。変えるのが悪いわけではなく準備が必要なだけ。",
            "match": lambda th, si, sg, tx: ("面倒" in sg) or ("いつも通り" in tx) or ("先のばし" in sg),
            "tips": [
                "“やるなら最初の1歩だけ”を決める（5分だけ・1問だけ）",
                "やらないコスト（時間・お金・機会）を書き出す"
            ],
            "score": lambda th, si, sg, tx: 0.65 if ("面倒" in sg or "先のばし" in sg) else 0.55
        },
        {
            "key": "bandwagon",
            "label": "同調バイアス（みんなに合わせすぎる）",
            "why": "『みんなやってる』は安心するけど、自分に合うかは別問題です。",
            "match": lambda th, si, sg, tx: ("みんな" in sg) or ("流行" in tx),
            "tips": [
                "利点と不安を1行ずつ書き出し“自分の目的”に合うか確認",
                "合わない所だけ別の方法を探す（全部マネしなくてOK）"
            ],
            "score": lambda th, si, sg, tx: 0.6
        },
        {
            "key": "affect",
            "label": "感情ヒューリスティック（不安や焦りで判断しがち）",
            "why": "強い感情は『今すぐ決めたい！』を生み、損得の見え方を変えます。",
            "match": lambda th, si, sg, tx: ("不安" in sg) or ("焦" in tx) or ("怖" in tx),
            "tips": [
                "深呼吸→10分後の自分が何と言うかを書いてみる（外部視点）",
                "いま決めない（24時間ルール）"
            ],
            "score": lambda th, si, sg, tx: 0.7 if ("焦" in tx or "怖" in tx) else 0.6
        },
    ]

    hits = []
    for spec in BIASES:
        if spec["match"](theme, situation, sign, text):
            hits.append({
                "label": spec["label"],
                "why": spec["why"],
                "evidence": [theme, situation, sign] + ([w for w in ["セール","定価","元値","成功","失敗","焦","怖","不安"] if w in text])[:3],
                "suggestions": spec["tips"],
                "score": spec["score"](theme, situation, sign, text),
            })

    # 重複や似たものを上限3件に
    hits = sorted(hits, key=lambda x: x["score"], reverse=True)[:3]
    return hits

# ================================
# 🔧 課金なし版：30バイアス対応のプチ診断エンジン
# ================================
import re, random

_BIASES = [
    # 1 確証バイアス
    {"key":"confirmation","name":"確証バイアス",
     "desc":"自分が信じたい結論に合う情報だけを重視し、反対情報を無視しがちな傾向。",
     "patterns":[r"絶対(に)?", r"間違いない", r"都合の悪い.*無視", r"自分(の|たちの)意見だけ", r"反対(意見|情報)は(見ない|要らない)"],
     "advice":[
         "反対意見・反例を3つ集めてから判断しましょう。",
         "支持データと反証データを**同数**並べて比較してみましょう。"
     ]},

    # 2 利用可能性ヒューリスティック
    {"key":"availability","name":"利用可能性ヒューリスティック",
     "desc":"印象に残る事例を過大評価し、全体の頻度や確率を歪める傾向。",
     "patterns":[r"最近(よく|頻繁に)見る", r"ニュースで(連日|毎日)", r"(一件|数件)の(事件|事例)で(全部|全体)を判断"],
     "advice":[
         "母数や母集団の**総数**を確認しましょう。",
         "強い事例より**基礎統計**を優先しましょう。"
     ]},

    # 3 アンカリング
    {"key":"anchoring","name":"アンカリング",
     "desc":"最初に見た数字や情報が基準になり、後の判断を引きずる現象。",
     "patterns":[r"最初(に|の)価格", r"第一印象", r"\d+%?引き", r"初回の情報が基準"],
     "advice":[
         "最初の数字を一旦隠し、独立して見積もり直しましょう。",
         "代替情報源を2つ以上加えて比較しましょう。"
     ]},

    # 4 バンドワゴン効果
    {"key":"bandwagon","name":"バンドワゴン効果",
     "desc":"『みんながそうしているから』で判断が左右される現象。",
     "patterns":[r"みんな(が|も)", r"流行(だから|ってる)", r"周りが(やってる|買ってる|言ってる)"],
     "advice":[
         "“自分にとっての利点/欠点”で再評価しましょう。",
         "人気の**根拠**（品質/価格/代替）を箇条書き比較しましょう。"
     ]},

    # 5 ハロー効果
    {"key":"halo","name":"ハロー効果",
     "desc":"目立つ特徴が他の評価まで良く/悪く見せてしまう現象。",
     "patterns":[r"(有名|人気|高評価)だから", r"肩書きが(ある|立派)だから", r"見た目が(良い|悪い)ので"],
     "advice":[
         "項目ごとに独立して評価表を作りましょう。",
         "情報源を分けて**ブラインド評価**してみましょう。"
     ]},

    # 6 権威バイアス
    {"key":"authority","name":"権威バイアス",
     "desc":"専門家や肩書きのある人の意見を過度に信頼してしまう傾向。",
     "patterns":[r"(専門家|医者|教授|有名人)が言ってた", r"テレビ(で|が)言ってた", r"公式だから正しい"],
     "advice":[
         "主張の**根拠**（データ/方法）を確認しましょう。",
         "別の専門家の見解も**2者以上**参照しましょう。"
     ]},

    # 7 自己奉仕バイアス
    {"key":"selfserving","name":"自己奉仕バイアス",
     "desc":"成功は自分の手柄、失敗は他者や環境のせいにしがち。",
     "patterns":[r"成功は自分(の|が)頑張った", r"失敗は(運|環境|他人)のせい", r"私は悪くない"],
     "advice":[
         "成功/失敗ともに**内的要因・外的要因**を両方書き出しましょう。",
         "第三者の視点で**事実列挙**を試しましょう。"
     ]},

    # 8 後知恵バイアス
    {"key":"hindsight","name":"後知恵バイアス",
     "desc":"結果を知った後で、最初から予測できたと錯覚する現象。",
     "patterns":[r"最初から(分かってた|そう思ってた)", r"やっぱり(そう|予想通り)"],
     "advice":[
         "当時の**不確実性**と代替シナリオを書き出しましょう。",
         "決定前のメモやログで**証跡確認**を。"
     ]},

    # 9 現状維持バイアス
    {"key":"statusquo","name":"現状維持バイアス",
     "desc":"変化より現状を過度に好む傾向。",
     "patterns":[r"今のままで良い", r"変更は(面倒|リスク)だ", r"前例がない"],
     "advice":[
         "変えないコスト/リスクも**数値化**して比較。",
         "小さな実験（PoC）で低リスクに試しましょう。"
     ]},

    # 10 正常性バイアス
    {"key":"normalcy","name":"正常性バイアス",
     "desc":"都合の悪い事態の可能性を過小評価し『大丈夫』と思い込む傾向。",
     "patterns":[r"自分は大丈夫", r"そんな(事故|災害)起こらない", r"過去も無事だった"],
     "advice":[
         "最悪ケースを**具体化**し、対策を1つ実行。",
         "近い事例のデータを見て**確率**を把握しましょう。"
     ]},

    # 11 ネガティビティバイアス
    {"key":"negativity","name":"ネガティビティバイアス",
     "desc":"悪い情報に過度に注意が向き、判断が悲観に偏る傾向。",
     "patterns":[r"悪いニュースばかり", r"どうせ失敗する", r"危ない(から|ので)やめる"],
     "advice":[
         "ポジ/ネガ情報を**対**で収集しバランス閲覧。",
         "“うまくいく条件”を**具体**に書き出しましょう。"
     ]},

    # 12 サンクコスト効果
    {"key":"sunkcost","name":"サンクコスト効果",
     "desc":"回収不能な投資を理由に、非合理な継続をしてしまう現象。",
     "patterns":[r"ここまで(時間|お金)をかけた", r"もったいないから続ける", r"やめたら損"],
     "advice":[
         "“今から”の費用対効果だけで判断しましょう。",
         "終了条件を**事前に**数値で決めておく。"
     ]},

    # 13 希少性バイアス
    {"key":"scarcity","name":"希少性バイアス",
     "desc":"希少・限定・残りわずかという情報で価値を過大評価する傾向。",
     "patterns":[r"限定|残りわずか|今だけ|先着", r"希少(価値|品)だから"],
     "advice":[
         "本来価値（品質/代替/用途）で評価し直しましょう。",
         "一晩寝かせる**クールダウン**を入れましょう。"
     ]},

    # 14 フレーミング効果
    {"key":"framing","name":"フレーミング効果",
     "desc":"同じ内容でも表現方法（90%成功 vs 10%失敗）で判断が変わる現象。",
     "patterns":[r"\d+%成功", r"\d+%失敗", r"言い換えで印象が変わる"],
     "advice":[
         "反対側の表現に**言い換え**て再評価。",
         "絶対数と割合の**両方**で比較しましょう。"
     ]},

    # 15 代表性ヒューリスティック
    {"key":"representativeness","name":"代表性ヒューリスティック",
     "desc":"典型像に当てはまるかどうかで確率を判断してしまう傾向。",
     "patterns":[r"〜っぽいから(大丈夫|危ない)", r"見た目(的|から)に", r"○○系の人は…"],
     "advice":[
         "**事前確率**（ベースレート）を確認。",
         "典型像から離れた**反例**も見ましょう。"
     ]},

    # 16 早計な一般化
    {"key":"overgeneralization","name":"早計な一般化",
     "desc":"少数の事例から全体を断定してしまう推論の飛躍。",
     "patterns":[r"(一人|一件|一度|たった数件).*(全部|いつも|必ず|日本は|世界は)", r"一例を根拠に全体を断定"],
     "advice":[
         "反例を最低2つ探し、適用範囲を**限定**。",
         "条件を書き出して**境界**を明確に。"
     ]},

    # 17 因果の取り違え（相関と因果の混同）
    {"key":"causation","name":"因果の取り違え（相関と因果の混同）",
     "desc":"同時に起きているだけで、因果関係があると誤解すること。",
     "patterns":[r"だから.*なった", r"一緒に増えた", r"同時に起きた=原因"],
     "advice":[
         "第3の要因（交絡）を検討しましょう。",
         "時系列と**反事実**（なかったら？）を確認。"
     ]},

    # 18 感情ヒューリスティック
    {"key":"affect","name":"感情ヒューリスティック",
     "desc":"好き嫌い・恐れ・不安など感情で素早く判断してしまう傾向。",
     "patterns":[r"なんか(好き|嫌い)", r"怖いからやめる", r"ムカつくので無理"],
     "advice":[
         "感情と事実を**別欄**に分けて整理。",
         "判断は**翌日**に回すクールダウン。"
     ]},

    # 19 自己中心バイアス
    {"key":"egocentric","name":"自己中心バイアス",
     "desc":"自分の見方が一般的だと思い込み、他者の視点を過小評価する傾向。",
     "patterns":[r"普通は(こう|こう思う)", r"みんな(そう|同じ)はず", r"自分が正しい"],
     "advice":[
         "関係者**3名以上**の視点を書き出す。",
         "“自分の知らない前提”がないか確認。"
     ]},

    # 20 集団同調バイアス
    {"key":"conformity","name":"集団同調バイアス",
     "desc":"周囲に合わせる圧力で、異なる意見を出しにくくなる現象。",
     "patterns":[r"空気を読む", r"反対すると(浮く|面倒)", r"会議で沈黙"],
     "advice":[
         "匿名アンケートで**事前に**意見収集。",
         "“反対役”を**役割として**置く。"
     ]},

    # 21 内集団バイアス
    {"key":"ingroup","name":"内集団バイアス",
     "desc":"所属集団を過度に好意的に捉える傾向。",
     "patterns":[r"うち(の|ら)は優秀", r"同じ(大学|会社|国)だから信用"],
     "advice":[
         "外部の評価指標や**第三者**の意見で検証。",
         "他集団の**強み**も列挙。"
     ]},

    # 22 外集団バイアス
    {"key":"outgroup","name":"外集団バイアス",
     "desc":"自分が属さない集団を一括りにし、否定的に捉える傾向。",
     "patterns":[r"他国の人は.*だ", r"○○人は(みんな|全員)", r"あの界隈は(ダメ|危険)"],
     "advice":[
         "個人差と**多様性**に注目。事例を**複数**比較。",
         "統計や一次情報に触れて**実像**を確認。"
     ]},

    # 23 アウトカムバイアス
    {"key":"outcome","name":"アウトカムバイアス",
     "desc":"結果の良し悪しで、意思決定の質まで評価してしまう現象。",
     "patterns":[r"結果が良かった=正しい判断", r"失敗=判断が悪い"],
     "advice":[
         "意思決定の**プロセス品質**で評価。",
         "当時得られた**情報範囲**で再検証。"
     ]},

    # 24 アクターバイアス（行為者−観察者偏差）
    {"key":"actorobserver","name":"アクターバイアス",
     "desc":"自分の失敗は状況のせい、他人の失敗は性格のせいにしがち。",
     "patterns":[r"自分は状況が悪かった", r"あの人は性格がダメ"],
     "advice":[
         "自分/他人の評価軸を**入れ替えて**書く。",
         "状況要因と個人要因を**同数**挙げる。"
     ]},

    # 25 根本的帰属の誤り
    {"key":"fundamental","name":"根本的帰属の誤り",
     "desc":"他者の行動原因を性格などの内的要因に過度に求める傾向。",
     "patterns":[r"怠け者だから失敗", r"根がだらしないから", r"性格が悪いから"],
     "advice":[
         "外的要因（制度/環境/情報）を書き出す。",
         "同じ状況なら自分は？**反事実**で考える。"
     ]},

    # 26 ポジティブ錯誤（楽観バイアス）
    {"key":"optimism","name":"ポジティブ錯誤（楽観バイアス）",
     "desc":"自分だけはうまくいく/問題は起きないと過小評価する傾向。",
     "patterns":[r"自分だけは大丈夫", r"なんとかなる(はず|でしょう)"],
     "advice":[
         "リスクを**確率×影響**で見積もり。",
         "第三者に**デビルズアドボケイト**を依頼。"
     ]},

    # 27 計画錯誤
    {"key":"planning","name":"計画錯誤",
     "desc":"必要な時間やコストを甘く見積もってしまう傾向。",
     "patterns":[r"すぐ終わる", r"想定より時間は(かからない|少ない)", r"見積もりは(楽観|控えめ)で良い"],
     "advice":[
         "過去の実績値から**係数**を掛ける（例：×1.5）。",
         "バッファ（時間/費用）を**明示**。"
     ]},

    # 28 自己成就予言
    {"key":"selffulfilling","name":"自己成就予言",
     "desc":"“どうせ無理”という信念が行動を抑制し、結果的に失敗を招く現象。",
     "patterns":[r"どうせ(無理|失敗)する", r"やっても意味がない"],
     "advice":[
         "最小の一歩（5分/1タスク）に**分割**して着手。",
         "“成功条件の最小セット”を定義。"
     ]},

    # 29 損失回避
    {"key":"lossaversion","name":"損失回避",
     "desc":"同じ大きさの利益より損失の痛みを強く感じ、挑戦を避けがち。",
     "patterns":[r"損をしたくない", r"リスクが怖い", r"現状の利益を守りたい"],
     "advice":[
         "損失上限を**先に**決め、ルール化。",
         "小さく試す**実験**で期待値を検証。"
     ]},

    # 30 現状認知の歪み（思い込み）
    {"key":"cognitivebias","name":"現状認知の歪み（思い込み）",
     "desc":"前提や視点が固定されて、他の可能性が見えなくなる状態。",
     "patterns":[r"他の選択肢が(見えない|ない)", r"常識だから正しい", r"昔からそうだから"],
     "advice":[
         "前提を**1つずつ反転**して再検討。",
         "別分野の**類似ケース**を参照。"
     ]},
]

def _score_bias(text: str, item: dict) -> float:
    """パターン一致数を簡易スコアに。0.0〜1.0"""
    hits = 0
    for pat in item["patterns"]:
        if re.search(pat, text, flags=re.IGNORECASE):
            hits += 1
    if not item["patterns"]:
        return 0.0
    # 検出感度：パターンの半分＋1ヒットで満点に近づく
    denom = max(2, len(item["patterns"]) // 2 + 1)
    return min(1.0, hits / denom)

def _format_diag(name, desc, tips):
    tip = random.choice(tips) if tips else ""
    return (
        f"**{name}** が含まれている可能性があります。\n"
        f"{desc}\n"
        f"**視野を広げるヒント:** {tip}"
    )

def analyze_with_ai(text: str, category=None, top_n: int = 3) -> str:
    """
    外部APIを使わず、文章の言い回しから代表的なバイアスを簡易推定。
    長めの“プチ診断”文を返す。
    """
    t = (text or "").strip()
    if not t:
        return "入力が空です。内容を入力してください。"

    # 各バイアスのスコア算出
    scored = []
    for b in _BIASES:
        s = _score_bias(t, b)
        if s > 0:
            scored.append((s, b))
    scored.sort(key=lambda x: x[0], reverse=True)
    top = [b for _, b in scored[:max(1, top_n)]]

    header = f"🧠 **入力内容:** {t}\n📂 **カテゴリ:** {category or '未選択'}\n---\n"
    if not top:
        body = ("🔎 目立つ認知バイアスは特に検出されませんでした。\n"
                "とはいえ、反例や別視点の情報を**意識的に**集める癖をつけると、よりバランスの良い判断に近づけます。")
    else:
        parts = []
        for b in top:
            parts.append(_format_diag(b["name"], b["desc"], b["advice"]))
        parts.append("📌 **ワンポイント:** 反対側の意見や別の国・事例も1つ参照してから結論づけると、判断の偏りを減らせます。")
        body = "\n\n".join(parts)

    return header + "✅ **AIプチ診断**\n" + body
